<% const {uploadedFileData} = req.session.eApp %>
<% const {preUploadErrors, infectedFiles, postUploadErrors} = messages %>
<% const postUploadErrorsExists = postUploadErrors.length > 0 %>
<% const preUploadErrorsExists = preUploadErrors.length > 0 %>
<% const infectedFileExists = infectedFiles.length > 0 %>
<% const errorsExist = preUploadErrorsExists || infectedFileExists || postUploadErrorsExists %>

<% pageTitle = (errorsExist ? 'Error:' : '') + "Add your PDFs" %>

<div class="inner_header <% if (!user_data.loggedIn){ %>no-user-signed-in<% } %>">
    <a href="<%= backLink %>" class="back-to-previous govuk-link">Back</a>
    <%- partial('../partials/inner-header')%>
</div>

<section class="column-two-thirds">

    <% if (errorsExist) { %>
        <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1"
            data-module="govuk-error-summary">
            <h2 class="govuk-error-summary__title" id="error-summary-title">
                There is a problem
            </h2>
            <div class="govuk-error-summary__body">
                <ul class="govuk-list govuk-error-summary__list">
                    <% if (preUploadErrorsExists) { %>
                        <li>
                            <a href="#error-list">One or more files could not be uploaded</a>
                        </li>
                    <% } %>
                    <% postUploadErrors.forEach((postUploadError) => { %>
                        <li>
                            <a href="#file-upload-form"><%= postUploadError %></a>
                        </li>
                    <% }); %>
                    <% if (infectedFileExists) { %>
                        <li>
                            <a href="#file-upload-form">
                                <% if (infectedFiles.length === 1) { %>
                                    The following file cannot be uploaded because it is infected (may contain a virus). You might be able to upload a
                                    different copy of this file:
                                <% } else { %>
                                    The following files cannot be uploaded because they are infected (may contain a virus). You might be able to upload
                                    different copies of these files:
                                <% } %>
                            </a>
                        </li>
                        <% infectedFiles.forEach((infectedFile) => { %>
                            <li><%= infectedFile %></li>
                        <% }); %>
                    <% } %>
                </ul>
            </div>
        </div>
    <% } %>

    <h1 class="heading-xlarge">Add your PDFs</h1>

    <p>It costs Â£30 for each uploaded PDF.</p>
    <p>You can upload a maximum of 50 PDFs in a single application.</p>
    <p>If you are unable to upload the PDFs you can still get the documents legalised by using the <a href="/new-application?app_type_group=1">paper-based service.</a>
    </p>

    <div class="multi-file-upload govuk-!-margin-top-9">
        <div class="multi-file-upload__form js-upload-btn">
            <form id="file-upload-form" action="/upload-file-handler" method="post" enctype="multipart/form-data" data-testid="upload-form" class="js-upload-form">
                <div class="multi-file-upload__input-wrapper<% if (postUploadErrorsExists) { %> govuk-form-group--error<% } %>">
                    <label class="form-label-bold multi-file-upload__label" for="file-upload-1">
                        Upload files
                    </label>
                    <% if (postUploadErrorsExists) { %>
                        <p id="file-upload-error" class="govuk-error-message">
                            <span class="govuk-visually-hidden">Error:</span> <%= postUploadErrors[0] %>
                        </p>
                    <% } %>
                    <input class="js-multi-file-input multi-file-upload__input" data-testid="upload-input" id="file-upload-1" name="documents" type="file" multiple accept="application/pdf"
                      <% if (preUploadErrorsExists) { %> aria-describedby="error-list"<% } %>
                    />
                </div>
                <button type="submit" class="govuk-button govuk-button--secondary js-trigger-progress-bar">
                    Upload
                </button>
            </form>
        </div>

        <div class="js-progress-bar govuk-!-display-none govuk-!-margin-bottom-4" aria-live="polite">
            <label class="js-upload-progress-text form-label-bold" for="upload-progress-bar" id="progressbarLabel">
                Uploading...
            </label>
            <div class="js-upload-progress-bar upload-progress__bar" aria-labelledby="progressbarLabel" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <% if (uploadedFileData.length > 0 || preUploadErrorsExists) { %>
            <div class="multi-file__uploaded-files">
                <% if (preUploadErrorsExists) { %>
                    <h2 class="heading-medium nomargintop" id="error-list">
                        <% if (preUploadErrors.length == 1) { %>
                            1 file
                        <% } else { %>
                            <%= preUploadErrors.length %> files
                        <% } %>
                        had preUploadErrors
                    </h2>
                    <div class="multi-file-upload__list">
                        <% preUploadErrors.forEach(function(item, errorIndex){ %>
                            <div class="multi-file-upload__error-item">
                                <p data-testid="errored-file-<%= errorIndex %>"><%- item.filename %></p>
                                <% item.errors.forEach(function(message, itemIndex){ %>
                                    <p class="govuk-error-message"
                                    data-testid="errored-file-<%= errorIndex %>-error-<%= itemIndex %>">
                                        <%- message %>
                                    </p>
                                <% }) %>
                            </div>
                        <% }); %>

                    </div>
                <% } %>
                <% if (uploadedFileData.length > 0) { %>
                    <form action="/delete-file-handler" method="post" data-testid="delete-form">
                        <h2 class="heading-medium nomargintop">
                            <% if (uploadedFileData.length === 1) { %>
                                1 file was uploaded
                            <% } else { %>
                                <%= uploadedFileData.length %> files were uploaded
                            <% } %>
                        </h2>
                        <div class="multi-file-upload__list">
                            <% uploadedFileData.forEach(function(item, idx){ %>
                                <div class="multi-file-upload__row">
                                    <div class="multi-file-upload__message" data-testid="uploaded-file-<%= idx %>">
                                        <%= item.filename %>
                                    </div>
                                    <div class="multi-file-upload__actions">
                                        <button type="submit" name="delete"
                                                class="multi-file-upload__delete govuk-button govuk-button--secondary govuk-!-margin-bottom-0"
                                                value="<%= item.filename %>">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </form>
                <% } %>
            </div>
        <% } %>
        <div>
            <% if (uploadedFileData.length > 0) { %>
                <a href="/additional-reference" class="govuk-button" draggable="false" role="button">
                    Continue
                </a>
            <% } %>
        </div>
    </div>
</section>
